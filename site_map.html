<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Яндекс ДТП Мониторинг</title>
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=3de168ba-04ed-42f5-bb4e-6abff9b3f317" type="text/javascript"></script>
</head>
<body>
<div id="map"></div>

<script>
ymaps.ready(init);

function init() {
    // Создаем карту, центрируем на Воронеж
    var myMap = new ymaps.Map("map", {
        center: [51.6833, 39.1802],
        zoom: 13,
        controls: []
    });

    window.__MY_MAP = myMap;
    var markersArray = [];
    window.__MY_MARKERS = markersArray;

    // Провайдер пробок с дорожными событиями
    var actualProvider = new ymaps.traffic.provider.Actual({}, { infoLayerShown: true });
    actualProvider.setMap(myMap);

    var infoLayer = new ymaps.traffic.InfoLayer(myMap, { provider: actualProvider });
    infoLayer.setMap(myMap);

    // Функция для получения только ДТП
    window.getIncidents = async function() {
        try {
            const provider = infoLayer.getProvider && infoLayer.getProvider();
            if (!provider) return [];

            const events = provider.getEvents ? provider.getEvents() : (provider.events || []);
            const results = [];

            if (events && events.forEach) {
                events.forEach(e => {
                    try {
                        const props = e.get && e.get("properties") ? e.get("properties").getAll() : e;
                        const coords = e.get && e.get("geometry") ? e.get("geometry").getCoordinates() : null;
                        const description = props.description || props.hintContent || props.name || "";

                        if (/ДТП/i.test(description)) {
                            results.push({
                                id: props.id || (coords ? coords.join(",") : description),
                                address: props.address || description,
                                lat: coords ? coords[0] : null,
                                lon: coords ? coords[1] : null
                            });
                        }
                    } catch(err){}
                });
            }

            return results;
        } catch (err) {
            console.error("Ошибка при сборе ДТП:", err);
            return [];
        }
    };
}
</script>
</body>
</html>
