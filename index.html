<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Яндекс ДТП Мониторинг</title>
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=3de168ba-04ed-42f5-bb4e-6abff9b3f317" type="text/javascript"></script>
</head>
<body>
<div id="map"></div>

<script>
ymaps.ready(init);

function init() {
    // Создаём карту
    var myMap = new ymaps.Map("map", {
        center: [51.6833, 39.1802],
        zoom: 13,
        controls: []
    });

    window.__MY_MAP = myMap;
    var markersArray = [];
    window.__MY_MARKERS = markersArray;

    // Провайдер пробок с дорожными событиями
    var actualProvider = new ymaps.traffic.provider.Actual({}, { infoLayerShown: true });
    actualProvider.setMap(myMap);

    // Функция для получения только ДТП
    window.getIncidents = function() {
        const events = actualProvider.getEvents ? actualProvider.getEvents() : [];
        const results = [];

        events.forEach(e => {
            const props = e.properties || {};
            const coords = e.geometry && e.geometry.coordinates ? e.geometry.coordinates : null;
            const type = props.type || "";

            // Фильтруем только ДТП
            if (/accident/i.test(type)) {
                results.push({
                    id: props.id || (coords ? coords.join(",") : props.name || ""),
                    address: props.name || "Адрес не указан",
                    lat: coords ? coords[1] : null,
                    lon: coords ? coords[0] : null,
                    type: type
                });
            }
        });

        return results;
    };
}
</script>
</body>
</html>
