<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Дорожные события Воронежа</title>
  <style>
    html, body, #map {
      width: 100%; 
      height: 100%; 
      margin: 0; 
      padding: 0;
      overflow: hidden;
      position: relative;
    }

    /* скрываем интерфейс */
    .ymaps-2-1-79-controls__control,
    .ymaps-2-1-79-controls__toolbar {
      display: none !important;
    }

    /* контейнер для водяных знаков */
    #watermarks {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* чтобы не мешать кликам */
      overflow: hidden;
      z-index: 9999;
      display: flex;
      flex-wrap: wrap;
      align-content: space-around;
      justify-content: space-around;
    }

    .watermark {
      font-size: 48px;
      font-weight: bold;
      color: rgba(255, 0, 0, 0.15); /* полупрозрачный красный */
      text-shadow: 1px 1px 2px black;
      transform: rotate(-30deg);
      margin: 50px;
      white-space: nowrap;
    }
  </style>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
</head>
<body>
  <div id="map"></div>

  <!-- Контейнер для повторяющихся водяных знаков -->
  <div id="watermarks"></div>

  <script>
    // Создаем сетку водяных знаков
    const watermarksContainer = document.getElementById('watermarks');
    const rows = 5; // количество рядов
    const cols = 5; // количество колонок
    for (let i = 0; i < rows * cols; i++) {
      const wm = document.createElement('div');
      wm.className = 'watermark';
      wm.textContent = 'АВАРИЙНЫЙ ПАТРУЛЬ';
      watermarksContainer.appendChild(wm);
    }

    ymaps.ready(function () {
      const map = new ymaps.Map("map", {
        center: [51.67, 39.19],
        zoom: 12,
        controls: []
        // обычная тема карты
      });

      const trafficControl = new ymaps.control.TrafficControl({
        state: { trafficShown: true },
        options: { visible: false }
      });
      map.controls.add(trafficControl);

      const provider = trafficControl.getProvider('traffic#actual');
      provider.state.set('infoLayerShown', true);

      // При каждом изменении — собираем ДТП
      provider.state.events.add('change', () => {
        if (!provider.state.get('isInited')) return;
        const events = provider.state.get('events') || [];
        const incidents = events
          .filter(e => e.type && e.type.toLowerCase().includes('дтп'))
          .map(e => ({
            title: e.type,
            description: e.description,
            coords: e.coords
          }));

        // Отправляем JSON наружу (бот его прочитает)
        window.dispatchEvent(new CustomEvent('trafficUpdate', { detail: incidents }));
      });
    });
  </script>
</body>
</html>
