<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Дорожные события Воронежа</title>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    /* скрываем интерфейс */
    .ymaps-2-1-79-controls__control,
    .ymaps-2-1-79-controls__toolbar {
      display: none !important;
    }
  </style>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
</head>
<body>
  <div id="map"></div>

  <script>
    ymaps.ready(function () {
      const voronezhCenter = [51.673, 39.210];
      const detailedZoom = 14;

      const map = new ymaps.Map("map", {
        center: voronezhCenter,
        zoom: detailedZoom,
        controls: []
      });

      const trafficControl = new ymaps.control.TrafficControl({
        state: { trafficShown: true },
        options: { visible: false }
      });
      map.controls.add(trafficControl);

      const provider = trafficControl.getProvider('traffic#actual');
      provider.state.set('infoLayerShown', true);

      // Маркеры и зоны для ДТП
      let incidentMarkers = [];
      let incidentZones = [];

      provider.state.events.add('change', () => {
        if (!provider.state.get('isInited')) return;

        const events = provider.state.get('events') || [];
        const incidents = events
          .filter(e => e.type && e.type.toLowerCase().includes('дтп'))
          .map(e => ({
            title: e.type,
            description: e.description,
            coords: e.coords
          }));

        // Удаляем старые маркеры и зоны
        incidentMarkers.forEach(marker => map.geoObjects.remove(marker));
        incidentZones.forEach(zone => map.geoObjects.remove(zone));
        incidentMarkers = [];
        incidentZones = [];

        if (incidents.length > 0) {
          const coordsForBounds = [];

          incidents.forEach(i => {
            // Маркер ДТП
            const marker = new ymaps.Placemark(i.coords, {
              balloonContent: `<b>${i.title}</b><br>${i.description}`
            }, {
              preset: 'islands#redIcon'
            });
            map.geoObjects.add(marker);
            incidentMarkers.push(marker);
            coordsForBounds.push(i.coords);

            // Зона вокруг ДТП (полупрозрачный круг, радиус 500 м)
            const zone = new ymaps.Circle([i.coords, 500], {}, {
              fillColor: 'rgba(255,0,0,0.2)',
              strokeColor: 'rgba(255,0,0,0.5)',
              strokeWidth: 2
            });
            map.geoObjects.add(zone);
            incidentZones.push(zone);
          });

          // Автоцентрирование и масштаб по всем ДТП
          map.setBounds(coordsForBounds, { checkZoomRange: true, zoomMargin: 50 });
        } else {
          // Если ДТП нет, возвращаемся к центру города
          map.setCenter(voronezhCenter, detailedZoom);
        }

        // Отправляем JSON наружу
        window.dispatchEvent(new CustomEvent('trafficUpdate', { detail: incidents }));
      });
    });
  </script>
</body>
</html>
