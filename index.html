<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MapKit ДТП Воронеж</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=0b912c39-2b07-41d8-96f5-ceeea79796ff&lang=ru_RU" type="text/javascript"></script>
    <style>
        html, body, #map {
            width: 100%; height: 100%; padding: 0; margin: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
ymaps.ready(init);

function init() {
    var map = new ymaps.Map("map", {
        center: [51.6720, 39.1843], // Воронеж
        zoom: 12,
        controls: ['zoomControl', 'fullscreenControl']
    });

    var trafficProvider = new ymaps.traffic.provider.Actual();
    trafficProvider.setMap(map);

    const sentEventIds = new Set();
    const geoObjects = new ymaps.GeoObjectCollection();

    map.geoObjects.add(geoObjects);

    async function sendEventToServer(eventData) {
        try {
            await fetch('http://80.93.61.59:5000/events', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(eventData)
            });
        } catch (e) {
            console.error('Ошибка при отправке события на сервер:', e);
        }
    }

    function scanRoadEvents() {
        trafficProvider.getRoadEvents().then(events => {
            events.forEach(event => {
                if (event.type && event.type.toLowerCase().includes('accident')) {
                    const id = event.id || event.hash;
                    if (!sentEventIds.has(id)) {
                        sentEventIds.add(id);

                        const coords = event.geometry.coordinates || [];
                        const description = event.description || '—';

                        // Добавляем маркер на карту
                        if (coords.length >= 2) {
                            const placemark = new ymaps.Placemark(coords, {
                                balloonContent: `<b>ДТП</b><br>${description}`
                            }, {
                                preset: 'islands#redIcon'
                            });
                            geoObjects.add(placemark);
                        }

                        const data = {
                            id: id,
                            type: event.type,
                            description: description,
                            coords: coords,
                            detectedAt: new Date().toISOString()
                        };
                        sendEventToServer(data);
                    }
                }
            });
        }).catch(err => console.error(err));
    }

    // Сканируем каждые 30 секунд
    setInterval(scanRoadEvents, 30000);
}
</script>
</body>
</html>
