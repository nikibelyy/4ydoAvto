<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Дорожные события Воронежа</title>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    /* скрываем интерфейс */
    .ymaps-2-1-79-controls__control,
    .ymaps-2-1-79-controls__toolbar {
      display: none !important;
    }
  </style>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
</head>
<body>
  <div id="map"></div>

  <script>
    ymaps.ready(function () {
      const map = new ymaps.Map("map", {
        center: [51.67, 39.19], // примерный центр Воронежа
        zoom: 12,
        controls: []
      });

      // Можно добавить границы города Воронежа через геообъект
      const voronezhBounds = [
        [51.563, 39.08], // юго-запад
        [51.743, 39.34]  // северо-восток
      ];

      map.setBounds(voronezhBounds, {
        checkZoomRange: true,  // чтобы масштаб автоматически подстроился
        zoomMargin: 20          // отступы, чтобы карта не была впритык
      });

      const trafficControl = new ymaps.control.TrafficControl({
        state: { trafficShown: true },
        options: { visible: false }
      });
      map.controls.add(trafficControl);

      const provider = trafficControl.getProvider('traffic#actual');
      provider.state.set('infoLayerShown', true);

      // При каждом изменении — собираем ДТП
      provider.state.events.add('change', () => {
        if (!provider.state.get('isInited')) return;
        const events = provider.state.get('events') || [];
        const incidents = events
          .filter(e => e.type && e.type.toLowerCase().includes('дтп'))
          .map(e => ({
            title: e.type,
            description: e.description,
            coords: e.coords
          }));

        // Отправляем JSON наружу (бот его прочитает)
        window.dispatchEvent(new CustomEvent('trafficUpdate', { detail: incidents }));
      });
    });
  </script>
</body>
</html>
