<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Дорожные события Воронежа</title>
  <style>
    html, body, #map {
      width: 100%; 
      height: 100%; 
      margin: 0; 
      padding: 0;
      overflow: hidden;
      background-color: #1b1b1b; /* фоновый цвет для ночной темы */
    }

    /* скрываем интерфейс */
    .ymaps-2-1-79-controls__control,
    .ymaps-2-1-79-controls__toolbar {
      display: none !important;
    }

    /* Водяной знак */
    #watermark {
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 24px;
      font-weight: bold;
      color: rgba(255, 0, 0, 0.5); /* полупрозрачный красный */
      text-shadow: 1px 1px 2px black;
      pointer-events: none; /* чтобы не мешал кликам по карте */
      z-index: 9999;
    }
  </style>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
</head>
<body>
  <div id="map"></div>
  <div id="watermark">АВАРИЙНЫЙ ПАТРУЛЬ</div>

  <script>
    ymaps.ready(function () {
      const map = new ymaps.Map("map", {
        center: [51.67, 39.19],
        zoom: 12,
        controls: [],
        type: 'yandex#dark' // ночная тема
      });

      const trafficControl = new ymaps.control.TrafficControl({
        state: { trafficShown: true },
        options: { visible: false }
      });
      map.controls.add(trafficControl);

      const provider = trafficControl.getProvider('traffic#actual');
      provider.state.set('infoLayerShown', true);

      // При каждом изменении — собираем ДТП
      provider.state.events.add('change', () => {
        if (!provider.state.get('isInited')) return;
        const events = provider.state.get('events') || [];
        const incidents = events
          .filter(e => e.type && e.type.toLowerCase().includes('дтп'))
          .map(e => ({
            title: e.type,
            description: e.description,
            coords: e.coords
          }));

        // Отправляем JSON наружу (бот его прочитает)
        window.dispatchEvent(new CustomEvent('trafficUpdate', { detail: incidents }));
      });
    });
  </script>
</body>
</html>
